# 区块链

## 第一部分

### 一、列举几个常见的合约攻击


### 二、什么是Layer0、Layer1、Layer2？

区块链具有六层架构：数据层、网络层、共识层、激励层、合约层和应用层

数据层和网络层是区块链的基本架构，也是整个区块链系统的最底层。

基本架构之上，共识层、激励层、合约层和应用层共同构成了区块链的协议部分。

1. Layer 0 又称数据传输层，对应OSI模型的底层，主要涉及区块链和传统网络之间的结合问题。
   1. 通常Layer 0是指传输数据的基础架构和协议层，一般承担的任务是区块链和传统互联网的结合，Layer 0当时也要负责和Layer 1 甚至和Layer 2的兼容，Layer 0作为基础，也经常会有扩容之类的需求，

    Polkadot是相对比较公认的一个提供了Layer 0的例子
    Polkadot项目主要是提供了一个叫中继链（Relay Chain）底层架构。

    这个中继链承担着保证在它之上的Layer 1的公链之间的沟通和安全的任务，换句话说，这个中继链是Layer 1的链互相高效沟通的信息桥梁，这也是为什么Polkadot经常被人称为是一个跨链的项目，这些在Polkadot中继链之上的，由开发者搭建起来的Layer 1的链，被称作Parachain，其中两个相对比较有名气的项目时Moonriver和Karura。

    因为他们在中继链的眼中，是平行的，是同一级别的。这种跨链的沟通，是非常有用的，因为良好的共通性，可以解决之前我们提到的目前比较不便的低效的信息共享问题

2. Layer 1 扩容方案又称链上扩容，指在区块链基层协议上实现的扩容解决方案。
   1. Layer 1定义可以说是区块链的底层架构和协议，他的另外一个名字是公链。
   2. Layer1的特点
       * 自己独立的链，不依赖于其他链，就可以独立运作
       * 支持独立运作，有配套的架构和参与机制，比如他们有自己的共识机制，有自己的Ledger(账本)，有自己的节点网络（node），有自己的加密算法，也有自己的原始代币
       * 他们通常都支持更上层的协议和应用从而打造他们自己的生态，但也有特殊情况，比如比特币的链，由于过于原始，在向上支持这一块做的比较少
   3. 知名的Layer 1 公链
       1. ethereum、Binance Smart Chain、TRON、Solana、Cardano
       2. 币币交易UniSwap、NFT交易平台OpenSea、稳定币DAI、链游axie

3. Layer 2 扩容方案又称链下扩容，指不改变区块链底层协议和基础规则，通过状态通道、侧链等方案提高交易处理速度。
   1. Layer 2是指以Layer 1为基础，建立在Layer 1之上的协议，他们并不是刚才我们提到的建立在Layer 1之上的应用，Layer 2的开发，其实目的也是为了解决很多Layer 1的问题，比如扩容和提速等等。

    其中比较通常的一个做法是，对于很多需要处理的复杂的交易，不是都在Layer 1的链上做处理和记录，

    而是拿下来在Layer 2的链处理，处理完之后，只是把处理结果的少量信息发回到Layer 1，

    目前主要的Layer 2还是围绕以太坊链来做的。

   2. 因为以太坊的生态是最大的，服务这个生态是最有利可图的，以太坊链有以下几个不同的扩容方案：
        Optimistic rollups 乐观汇总
        Zero-knowledge rollups 零知识汇总
        State channels 状态通道
        Sidechains 侧链
        Plasma 子链
        Validiums 有效性证明
    3. Layer 2和Layer 1 的主要区别
        他对节点的要求是很随意的

        不像Layer 1通常采用比较分布式的共识机制

        Layer 2的Node可能是一个或者一些server的cluster

        参与的可能是一大群个体，也可能是一个公司或者商业组织，甚至是少数的个人节点，除了Node之外，根据方向的不同，也可能被成为Operator、sequencer之类的。

        Layer 2的安全性还是主要依托于他对应的Layer 1的链

        Layer 1和Layer 2是有最广泛共识的
总结下来：
Layer 0是最底层的架构，用于帮助Layer 1的链之间的跨链沟通，同时有些也承担和传统网络沟通的任务

Layer 1是我们最常见的链，也是比较底层的架构，通常知名的Layer 1的链都有自己的庞大生态，Layer 1主要用来支持基于它的协议，在他上面开发的区块链应用。

Layer 2的链通常是为了实现Layer 1的扩容而存在的。

### 三、共识算法

区块链中五种常见共识算法

由于点对点网络下存在较高的网络延迟，各个节点所观察到的事务先后顺序不可能完全一致。因此，区块链系统需要设计一种机制对在差不多时间内发生的事务的先后顺序进行共识。这种对一个时间窗口内的事务的先后顺序达成共识的算法被称为 “共识机制”。

那么，区块链中常见的共识算法都有哪些呢？

   1. POW：Proof of Work，工作量证明
   POW 是比特币在 Block 的生成过程中使用的一种共识算法，也可以说是最原始的区块链共识算法了。POW 工作量证明，简单地理解就是，通过一份证明来确认做过一定量的工作。

   在比特币系统中，得到合理的 Block Hash 需要经过大量尝试计算。当某个节点提供出一个合理的 Block Hash 值，说明该节点确实经过了大量的尝试计算。

   这种工作量证明的形式，在我们日常生活中也十分常见。比如驾照，能拿到驾照，说明你已经进行过为期几个月甚至几年的练车和考试；再比如现在很火的吃鸡和王者荣耀游戏中的 K/D（Kill/Death）和胜率，分值越高证明你越厉害，同时也说明你进行了大量的游戏练习和技巧学习。

   2. POS：Proof of Stake，权益证明
   由于 POW 机制存在消耗算力巨大、交易确认时间较长，挖矿活动集中容易形成中心化等缺点，便演进出了 POS 权益证明。POS 简单来说，就是一个根据持有数字货币数量和时间来分配相应利息的制度，类似平时我们在银行中存款。

   基于权益证明共识的区块链系统中，参与者的角色是验证者 Validator，只需要投资系统的数字货币并在特定时间内验证自己是否为下一区块创造者，即可完成下一区块的创建。下一区块创造者是以某种确定的方式来选择，验证者被选中为下一区块创造者的概率与其所拥有的系统中数字货币的数量成正比例，即拥有 300 个币的验证者被选中的概率是拥有 100 个币验证者的 3 倍。

   在 POS 模式下，有一个名词叫币龄，每个币每天产生 1 币龄。比如你持有 100 个币，总共持有了 30 天，那么，此时你的币龄就为 3000。这个时候，如果你验证了一个 POS 区块，你的币龄就会被清空为 0，同时从区块中获得相对应的数字货币利息。

   这下就很有意思了，持币有利息。并且由于 POS 是在一个有限的空间里完成，不是像 POW 那样在无限空间里寻找，因此无需大量能源消耗。

   3. DPOS：Delegated Proof of Stake，授权权益证明
   DPOS 最早出现在比特股中，又称受托人机制，它的原理是让每一个持有比特股的人进行投票，由此产生 101 位代表 。我们可以将其理解为 101 个超级节点或者矿池，而这 101 个超级节点彼此的权利完全相等。

   从某种角度来看，DPOS 有点像是议会制度或人民代表大会制度。如果代表不能履行他们的职责（当轮到他们时，没能生成区块），他们会被除名，网络会选出新的超级节点来取代他们。DPOS 的出现最主要还是因为矿机的产生，大量的算力在不了解也不关心数字货币的人身上，类似演唱会的黄牛，大量囤票而丝毫不关心演唱会的内容。

   DPOS 通过其选择区块生产者和验证节点质量的算法确保了安全性，同时消除了交易需要等待一定数量区块被非信任节点验证的时间消耗。通过减少确认的要求，DPOS 算法大大提高了交易的速度。通过信任少量的诚信节点，可以去除区块签名过程中不必要的步骤。

   4. PBFT：Practical Byzantine FaultTolerance，实用拜占庭容错
   PBFT 意为实用拜占庭容错算法，该算法由 Miguel Castro (卡斯特罗) 和 Barbara Liskov（利斯科夫）在 1999 年提出来，解决了原始拜占庭容错算法效率不高的问题，将算法复杂度由指数级降低到多项式级，使得拜占庭容错算法在实际系统应用中变得可行。

   PBFT 是一种状态机副本复制算法，即服务作为状态机进行建模，状态机在分布式系统的不同节点进行副本复制。每个状态机的副本都保存了服务的状态，同时也实现了服务的操作。

   将所有的副本组成的集合使用大写字母 R 表示，使用 0 到 | R|-1 的整数表示每一个副本。为了描述方便，假设 | R|=3f+1，这里 f 是有可能失效的副本的最大个数。尽管可以存在多于 3f+1 个副本，但是额外的副本除了降低性能之外不能提高可靠性。

   5. RAFT，一致性共识算法
   RAFT 算法包含三种角色，分别是：跟随者（follower），候选人（candidate）和领导者（leader）。集群中的一个节点在某一时刻只能是这三种状态的其中一种，这三种角色可以随着时间和条件的变化而互相转换。

   RAFT 算法主要有两个过程：一个过程是领导者选举，另一个过程是日志复制，其中日志复制过程会分记录日志和提交数据两个阶段。RAFT 算法支持最大的容错故障节点是（N-1）/2，其中 N 为集群中总的节点数量。

### 四、预言机

预言机是将以太坊连接到链外、真实世界信息的数据源，以便您可以在智能合约中查询数据。

预言机是区块链与真实世界之间的桥梁。 他们充当在链上的应用程序接口

使用以太坊这样的区块链，您需要确保：网络中每个节点都能够重放每个交易，并最终产生同样的结果

Oracle 问题

如前所述，以太坊交易无法直接获取链下数据。 同时，依靠单一的事实来源提供数据并不安全，会使智能合约的去中心化失效。 这便是预言机的问题。

我们可以使用去中心化预言机拉取多个数据来源，以避免预言机的问题；如果某个数据源被破解或失效，智能合约仍将按预期运行。