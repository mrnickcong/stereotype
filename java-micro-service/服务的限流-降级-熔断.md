# 服务限流-降级-熔断

- [服务限流-降级-熔断](#服务限流-降级-熔断)
  - [概述](#概述)
    - [什么是限流](#什么是限流)
    - [什么是降级](#什么是降级)
    - [什么是熔断](#什么是熔断)
    - [三者的区别与联系](#三者的区别与联系)
  - [服务限流](#服务限流)
    - [常见的限流算法](#常见的限流算法)
      - [固定窗口限流算法](#固定窗口限流算法)
      - [滑动窗口限流算法](#滑动窗口限流算法)
      - [漏桶算法](#漏桶算法)
      - [令牌桶算法](#令牌桶算法)
  - [服务降级](#服务降级)
  - [服务熔断](#服务熔断)

## 概述

在分布式系统中，如果某个服务节点发生故障或者网络发生异常，都有可能导致调用方被阻塞等待，如果超时时间设置很长，调用方资源很可能被耗尽。这又导致了调用方的上游系统发生资源耗尽的情况，最终导致系统雪崩。

提高系统的整体容错能力是防止系统雪崩的有效手段。要防止系统发生雪崩，就必须要有容错设计。

如果遇到突增流量，一般的做法是对非核心业务功能采用熔断和服务降级的措施来保护核心业务功能正常服务，而对于核心功能服务，则需要采用限流的措施。

### 什么是限流

- 限流，也称流量控制。是指系统在面临高并发，或者大流量请求的情况下，限制新的请求对系统的访问，从而保证系统的稳定性。
- 限流会导致部分用户请求处理不及时或者被拒，这就影响了用户体验
- 一般需要在系统稳定和用户体验之间平衡

### 什么是降级

### 什么是熔断

### 三者的区别与联系

- 限流、熔断与降级，此三者都是流量过大时，通过一定的方式去保护系统的手段，是应对海量服务的三大“神器”
- 限流是从系统的流量入口考虑，从进入的流量上进行限制，达到保护系统的作用

## 服务限流

### 常见的限流算法

- 固定窗口限流算法
- 滑动窗口限流算法
- 漏斗算法
- 令牌桶算法

#### 固定窗口限流算法

首先维护一个计数器，将单位时间段当做一个窗口，计数器记录这个窗口接收请求的次数。

当次数少于限流阀值，就允许访问，并且计数器+1
当次数大于限流阀值，就拒绝访问。
当前的时间窗口过去之后，计数器清零。


#### 滑动窗口限流算法

滑动窗口限流解决固定窗口临界值的问题。它将单位时间周期分为n个小周期，分别记录每个小周期内接口的访问次数，并且根据时间滑动删除过期的小周期。

滑动窗口算法虽然解决了固定窗口的临界问题，但是一旦到达限流后，请求都会直接暴力被拒绝。酱紫我们会损失一部分请求，这其实对于产品来说，并不太友好。

#### 漏桶算法

漏桶算法面对限流，就更加的柔性，不存在直接的粗暴拒绝。

它的原理很简单，可以认为就是注水漏水的过程。往漏桶中以任意速率流入水，以固定的速率流出水。当水超过桶的容量时，会被溢出，也就是被丢弃。因为桶容量是不变的，保证了整体的速率。

在正常流量的时候，系统按照固定的速率处理请求，是我们想要的。但是面对突发流量的时候，漏桶算法还是循规蹈矩地处理请求，这就不是我们想看到的啦。流量变突发时，我们肯定希望系统尽量快点处理请求，提升用户体验嘛。

#### 令牌桶算法

面对突发流量的时候，我们可以使用令牌桶算法限流。

令牌桶算法原理：

有一个令牌管理员，根据限流大小，定速往令牌桶里放令牌。
如果令牌数量满了，超过令牌桶容量的限制，那就丢弃。
系统在接受到一个用户请求时，都会先去令牌桶要一个令牌。如果拿到令牌，那么就处理这个请求的业务逻辑；
如果拿不到令牌，就直接拒绝这个请求。

如果令牌发放的策略正确，这个系统即不会被拖垮，也能提高机器的利用率。Guava的RateLimiter限流组件，就是基于令牌桶算法实现的。

## 服务降级

## 服务熔断
