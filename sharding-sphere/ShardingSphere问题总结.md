# ShardingSphere问题总结

- [ShardingSphere问题总结](#shardingsphere问题总结)
  - [数据库架构演变与分库分表介绍](#数据库架构演变与分库分表介绍)
    - [海量数据为什么需要MySQL等OLTP数据库](#海量数据为什么需要mysql等oltp数据库)
      - [大数据存储无法替代](#大数据存储无法替代)
      - [NOSQL数据无法替代](#nosql数据无法替代)
    - [MySQL存储海量数据存在的问题](#mysql存储海量数据存在的问题)
    - [MySQL存储海量数据的架构演进](#mysql存储海量数据的架构演进)
      - [数据库单库存在问题](#数据库单库存在问题)
      - [数据库主从复制、读写分离](#数据库主从复制读写分离)
  - [读写分离](#读写分离)
    - [什么要读写分离](#什么要读写分离)
    - [读写分离的方式](#读写分离的方式)
  - [分库分表](#分库分表)
    - [什么是分库分表](#什么是分库分表)
    - [为什么要分库分表](#为什么要分库分表)
      - [性能上](#性能上)
      - [可用性上](#可用性上)
    - [分库分表带来的问题](#分库分表带来的问题)
    - [什么情况下要分库分表](#什么情况下要分库分表)
    - [分库分表的方式](#分库分表的方式)
      - [垂直拆分](#垂直拆分)
        - [垂直分库](#垂直分库)
        - [垂直分表](#垂直分表)
      - [水平拆分](#水平拆分)
        - [水平分库](#水平分库)
        - [水平分表](#水平分表)

## 数据库架构演变与分库分表介绍

### 海量数据为什么需要MySQL等OLTP数据库

#### 大数据存储无法替代

- 大数据存储的适用场景：低价值密度的数据，
- 需要进行数据建模、清洗等
  
#### NOSQL数据无法替代

- NOSQL数据库对**事物支持**不完善

### MySQL存储海量数据存在的问题

- 用户请求量大
- 单库、单表的数据量过大

### MySQL存储海量数据的架构演进

- 早期阶段：数据库单库
- 初期阶段：数据库主从复制、读写分离
- 发展阶段：数据库主从复制、读写分离+缓存
- 后期阶段：分库分表

#### 数据库单库存在问题

- 数据库可用性。宕机后应用无法访问
- 数据库单表操作大量数据会有效率和性能的问题

#### 数据库主从复制、读写分离

- 读写分离：解决了大量查询性能问题，没有解决大量增删改的问题

## 读写分离

### 什么要读写分离

### 读写分离的方式

- 基于代码的
- 基于中间件的

## 分库分表

### 什么是分库分表

简单来说，通过某种特定的条件，将我们存放在同一个数据库中的数据分散存放到多个数据库（主机）上面，以达到分散单台设备负载的效果

### 为什么要分库分表

关键字：提升性能、增加可用性。

#### 性能上

- 数据量过多，查询查询时间变长，效率变慢
- MySQL在插入数据的时候，会对表进行加锁，分为表锁定和行锁定
- 请求数量变多，查询性能降低

#### 可用性上

- 单库部署在数据库宕机风险下导致可用性降低

一般来说 MySQL 数据库单表记录最好控制在 500 万条(这是个经验数字)，超过1000万数据量或者100G考虑分表

### 分库分表带来的问题

关系型数据库在单机单库的情况下,比较容易出现性能瓶颈问题,分库分表可以有效的解决这方面的问题,但是同时也会产生一些 比较棘手的问题.

**1) 事务一致性问题**

- 当我们需要更新的内容同时分布在不同的库时, 不可避免的会产生跨库的事务问题.  原来在一个数据库操作, 本地事务就可以进行控制, 分库之后 一个请求可能要访问多个数据库,如何保证事务的一致性,目前还没有简单的解决方案.

**2) 跨节点关联的问题**

- 在分库之后, 原来在一个库中的一些表,被分散到多个库,并且这些数据库可能还不在一台服务器,无法关联查询.解决这种关联查询,需要我们在代码层面进行控制,将关联查询拆开执行,然后再将获取到的结果进行拼装.

**3) 分页排序查询的问题**

- 分库并行查询时,如果用到了分页 每个库返回的结果集本身是无序的, 只有将多个库中的数据先查出来,然后再根据排序字段在内存中进行排序,如果查询结果过大也是十分消耗资源的.

**4) 主键避重问题**

- 在分库分表的环境中,表中的数据存储在不同的数据库, 主键自增无法保证ID不重复, 需要单独设计全局主键.

**5) 公共表的问题**

- 不同的数据库,都需要从公共表中获取数据. 某一个数据库更新看公共表其他数据库的公共表数据需要进行同步.

**上面我们说了分库分表后可能会遇到的一些问题, 接下来带着这些问题,我们就来一起来学习一下Apache ShardingSphere !**

### 什么情况下要分库分表

- 单机存储容量达到瓶颈
- 数据库连接数处理能力达到上限

一般情况下：

- 垂直拆分会在数据库的设计阶段完成，
- 后续的性能优化优先选择SQL优化、表字段优化、索引优化、增加缓存等方式
- 如果上述情况仍然存在问题，再考虑分表

### 分库分表的方式

分库分表的方式在生产中通常包括四种：

- 垂直分库
- 垂直分表
- 水平分库
- 水平分表

#### 垂直拆分

垂直拆分包括垂直分库和垂直分表，主要侧重于库和表结构上的拆分

1. 解决了业务层面的耦合、业务清晰
2. 能对不同的业务数据进行分级管理
3. 在高并发场景下，一定程度上可以提高数据库的访问性能
4. 垂直拆分没有解决单表数据量过大的问题

##### 垂直分库

根据不同的业务，划分不同的数据库

##### 垂直分表

将一个大表的数据结构进行拆分，划分不同的表结构，表与表之间通过关联字段进行关联

#### 水平拆分

水平拆分：数据结构都是一样的，侧重于对数据进行分片存储

##### 水平分库

##### 水平分表
