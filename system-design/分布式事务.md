# 分布式事务

- [分布式事务](#分布式事务)
  - [1. 事务](#1-事务)
    - [1.1 何为事务](#11-何为事务)
    - [1.2 数据库本地事务四大特性](#12-数据库本地事务四大特性)
  - [2. 分布式事务](#2-分布式事务)
    - [2.1 何为分布式事务](#21-何为分布式事务)
    - [2.2 分布式事务的目的](#22-分布式事务的目的)
    - [2.3 分布式事务的基础](#23-分布式事务的基础)
      - [2.3.1 CAP理论](#231-cap理论)
      - [2.3.2 BASE理论](#232-base理论)
  - [3. 分布式事务解决方案](#3-分布式事务解决方案)
    - [3.1 分布式事务解决思路](#31-分布式事务解决思路)
    - [3.2 分布式事务几种常见的方案](#32-分布式事务几种常见的方案)
  - [二段提交](#二段提交)
    - [三阶段](#三阶段)

## 1. 事务

### 1.1 何为事务

事务提供一种机制将一个活动涉及的所有操作纳入到一个不可分割的执行单元，组成事务的所有操作只有在所有操作均能正常执行的情况下方能提交，只要其中任一操作执行失败，都将导致整个事务的回滚。简单地说，事务提供一种“要么什么都不做，要么做全套（All or Nothing）”机制。

### 1.2 数据库本地事务四大特性

ACID
说到数据库事务就不得不说，数据库事务中的四大特性，ACID:

- A:原子性(Atomicity)

> 一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。
就像你买东西要么交钱收货一起都执行，要么要是发不出货，就退钱。

- C:一致性(Consistency)

> 事务的一致性指的是在一个事务执行之前和执行之后数据库都必须处于一致性状态。如果事务成功地完成，那么系统中所有变化将正确地应用，系统处于有效状态。如果在事务中出现错误，那么系统中的所有变化将自动地回滚，系统返回到原始状态。

- I:隔离性(Isolation)

> 指的是在并发环境中，当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间。由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。事务查看数据更新时，数据所处的状态要么是另一事务修改它之前的状态，要么是另一事务修改它之后的状态，事务不会查看到中间状态的数据。
打个比方，你买东西这个事情，是不影响其他人的。

- D:持久性(Durability)

> 指的是只要事务成功结束，它对数据库所做的更新就必须永久保存下来。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。
打个比方，你买东西的时候需要记录在账本上，即使老板忘记了那也有据可查。

## 2. 分布式事务

### 2.1 何为分布式事务

分布式事务就是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。

简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。

### 2.2 分布式事务的目的

本质上来说，分布式事务就是为了保证不同数据库的数据一致性

### 2.3 分布式事务的基础

从上面来看分布式事务是随着互联网高速发展应运而生的，这是一个必然的我们之前说过数据库的ACID四大特性，已经无法满足我们分布式事务，这个时候又有一些新的大佬提出一些新的理论:

- CAP理论
- BASE理论

#### 2.3.1 CAP理论

CAP定理，又被叫作布鲁尔定理。对于设计分布式系统来说(不仅仅是分布式事务)的架构师来说，CAP就是你的入门理论。

- C (一致性):对某个指定的客户端来说，读操作能返回最新的写操作。对于数据分布在不同节点上的数据上来说，如果在某个节点更新了数据，那么在其他节点如果都能读取到这个最新的数据，那么就称为强一致，如果有某个节点没有读取到，那就是分布式不一致。
- A (可用性)：非故障的节点在合理的时间内返回合理的响应(不是错误和超时的响应)。可用性的两个关键一个是合理的时间，一个是合理的响应。合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回。合理的响应指的是系统应该明确返回结果并且结果是正确的，这里的正确指的是比如应该返回50，而不是返回40。
- P (分区容错性):当出现网络分区后，系统能够继续工作。打个比方，这里个集群有多台机器，有台机器网络出现了问题，但是这个集群仍然可以正常工作。

熟悉CAP的人都知道，三者不能共有，如果感兴趣可以搜索CAP的证明，在分布式系统中，网络无法100%可靠，分区其实是一个必然现象，如果我们选择了CA而放弃了P，那么当发生分区现象时，为了保证一致性，这个时候必须拒绝请求，但是A又不允许，所以分布式系统理论上不可能选择CA架构，只能选择CP或者AP架构。

对于CP来说，放弃可用性，追求一致性和分区容错性，我们的zookeeper其实就是追求的强一致。
对于AP来说，放弃一致性(这里说的一致性是强一致性)，追求分区容错性和可用性，这是很多分布式系统设计时的选择，后面的BASE也是根据AP来扩展。

顺便一提，CAP理论中是忽略网络延迟，也就是当事务提交时，从节点A复制到节点B，但是在现实中这个是明显不可能的，所以总会有一定的时间是不一致。同时CAP中选择两个，比如你选择了CP，并不是叫你放弃A。因为P出现的概率实在是太小了，大部分的时间你仍然需要保证CA。就算分区出现了你也要为后来的A做准备，比如通过一些日志的手段，是其他机器回复至可用。

#### 2.3.2 BASE理论

BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。是对CAP中AP的一个扩展

基本可用:分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。
软状态:允许系统中存在中间状态，这个状态不影响系统可用性，这里指的是CAP中的不一致。
最终一致:最终一致是指经过一段时间后，所有节点数据都将会达到一致。

BASE解决了CAP中理论没有网络延迟，在BASE中用软状态和最终一致，保证了延迟后的一致性。BASE和 ACID 是相反的，它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。

## 3. 分布式事务解决方案

### 3.1 分布式事务解决思路

- 分布式事务处理的关键：必须有一种方法知道事务在任何地方所做的所有的动作。
- 提交或回滚事务的决定必须产生统一的结果，要么全部提交、要么全部回滚。

### 3.2 分布式事务几种常见的方案

- 二段提交（2PC）
- 三段提交（3PC）
- TCC
- 本地消息表
- MQ事务
- Saga事务

XA规范

## 二段提交

第一阶段：投票阶段
第二阶段：执行/回滚阶段

优点：可以保证数据一致性
缺点：

- 单点故障问题
- 阻塞资源
- 数据不一致

### 三阶段

第一阶段：can commit
第二价段：pre commit
第三阶段：do commit

can commit 结果：

1. 有参与者返回No
2. 协调者等待超时
3. 参与者没有收到协调者指令
